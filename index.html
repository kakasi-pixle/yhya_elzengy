<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>لعبة السفينة</title>
<style>
body{margin:0;overflow:hidden;background:#001022;touch-action:none}
canvas{display:block}

/* joystick */
#joystick{
 position:fixed;bottom:40px;left:40px;
 width:120px;height:120px;border-radius:50%;
 background:rgba(255,255,255,.2)
}
#stick{
 position:absolute;left:40px;top:40px;
 width:40px;height:40px;border-radius:50%;
 background:#fff
}

/* إعادة المحاولة */
#retry{
 position:fixed;top:60%;left:50%;
 transform:translate(-50%,-50%);
 background:#00e6ff;color:#001022;
 padding:14px 30px;font-size:22px;
 border-radius:12px;
 display:none;
}

/* دم البوص */
#bossHp{
 position:fixed;
 top:20px;
 left:50%;
 transform:translateX(-50%);
 width:300px;
 height:20px;
 border:2px solid #fff;
 display:none;
}
#bossHpInner{
 height:100%;
 background:red;
 width:100%;
}
</style>
</head>
<body>

<canvas id="game"></canvas>
<div id="joystick"><div id="stick"></div></div>
<div id="retry">أعد المحاولة</div>
<div id="bossHp"><div id="bossHpInner"></div></div>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
canvas.width=innerWidth;
canvas.height=innerHeight;

// الصور
const imgEnemy=new Image(); imgEnemy.src="zen1.png";
const imgBoss=new Image();  imgBoss.src="zen3.png";
const imgAlly=new Image();  imgAlly.src="zen4.png";
const imgWin=new Image();   imgWin.src="zen.png";

// اللاعب
let player={x:canvas.width/2,y:canvas.height-150};

// الحليف
let ally=null;

// البوص
let boss=null,bossDir=1;

// مراحل اللعبة
let stage="enemies"; // enemies | boss | win | lose

// أعداء
let enemies=[],spawned=0,killed=0;

// طلقات
let lasers=[],allyLasers=[],bossLasers=[];

// joystick
const joy=document.getElementById("joystick");
const stick=document.getElementById("stick");
let jx=0,jy=0,active=false;

joy.addEventListener("touchstart",()=>active=true);
joy.addEventListener("touchend",()=>{
 active=false;jx=jy=0;
 stick.style.left="40px";stick.style.top="40px";
});
joy.addEventListener("touchmove",e=>{
 if(!active)return;
 let r=joy.getBoundingClientRect();
 let x=e.touches[0].clientX-r.left-60;
 let y=e.touches[0].clientY-r.top-60;
 let d=Math.min(40,Math.hypot(x,y));
 let a=Math.atan2(y,x);
 jx=Math.cos(a)*d/40;
 jy=Math.sin(a)*d/40;
 stick.style.left=40+jx*40+"px";
 stick.style.top=40+jy*40+"px";
});

// إعادة المحاولة
document.getElementById("retry").onclick=()=>location.reload();

// spawn enemies
function spawnEnemy(){
 if(spawned<10){
  enemies.push({x:Math.random()*(canvas.width-100)+50,y:-100,alive:true});
  spawned++;
 }
}
setInterval(()=>{ if(stage==="enemies")spawnEnemy() },900);

// ضرب اللاعب
setInterval(()=>{
 if(stage==="enemies" || stage==="boss") lasers.push({x:player.x,y:player.y,hit:false});
},300);

// ضرب الحليف (متعرج)
let zigzagDir=1;
setInterval(()=>{
 if(stage==="boss" && ally){
  allyLasers.push({
   x:ally.x,
   y:ally.y,
   vx:(Math.random()-0.5)*2,
   zigzag:zigzagDir
  });
  zigzagDir*=-1;
 }
},450);

// update
let bossHp=document.getElementById("bossHp");
let bossHpInner=document.getElementById("bossHpInner");

function update(){
 if(stage==="lose" || stage==="win") return; // توقف كل شيء عند الخسارة أو الفوز

 // حركة اللاعب أسرع
 player.x+=jx*10;
 player.y+=jy*10;
 player.x=Math.max(30,Math.min(canvas.width-30,player.x));
 player.y=Math.max(30,Math.min(canvas.height-30,player.y));

 // مرحلة الأعداء
 if(stage==="enemies"){
  enemies.forEach(e=>e.alive&&(e.y+=1.8));
  lasers.forEach(l=>{
   l.y-=16;
   enemies.forEach(e=>{
    if(e.alive&&!l.hit && Math.abs(l.x-e.x)<45 && Math.abs(l.y-e.y)<45){
     e.alive=false; l.hit=true; killed++;
    }
   });
  });
  if(killed===10){
   stage="boss";
   boss={x:canvas.width/2,y:140,hp:100};
   ally={x:player.x+80,y:player.y+40};
   bossHp.style.display="block";
  }
 }

 // مرحلة البوص
 if(stage==="boss"){
  boss.x+=bossDir*2.2;
  boss.y+=Math.sin(Date.now()/400)*0.8;
  if(boss.x>canvas.width-120)bossDir=-1;
  if(boss.x<120)bossDir=1;

  // الحليف يتحرك مع اللاعب
  ally.x=player.x+80;
  ally.y=player.y+40;

  // ضرب البوص (مثل اللاعب)
  lasers.forEach(l=>{
   l.y-=16;
   if(!l.hit && Math.abs(l.x-boss.x)<90 && Math.abs(l.y-boss.y)<90){
    boss.hp-=1; l.hit=true;
   }
  });

  // ضرب الحليف متعرج
  allyLasers.forEach(l=>{
   l.y-=12;
   l.x+=l.vx + l.zigzag*2;
   if(Math.abs(l.x-boss.x)<90 && Math.abs(l.y-boss.y)<90){
    boss.hp-=2; l.y=-999;
   }
  });

  // ضرب البوص للاعب مثل اللاعب
  bossLasers.push({x:boss.x,y:boss.y});
  bossLasers.forEach((l,i)=>{
   l.y+=16;
   if(Math.abs(l.x-player.x)<26 && Math.abs(l.y-player.y)<26){
    stage="lose";
    bossHp.style.display="none";
    document.getElementById("retry").style.display="block";
   }
   if(l.y>canvas.height) bossLasers.splice(i,1);
  });

  // تحديث شريط الدم
  bossHpInner.style.width=boss.hp+'%';

  if(boss.hp<=0){
    stage="win";
    bossHp.style.display="none";
  }
 }
}

// draw
let winFly=[];
for(let i=0;i<25;i++){
 winFly.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,
  vx:(Math.random()-0.5)*2,vy:(Math.random()-0.5)*2,size:60+Math.random()*40});
}

function draw(){
 ctx.clearRect(0,0,canvas.width,canvas.height);

 // السفينة
 ctx.save();
 ctx.translate(player.x,player.y);
 ctx.fillStyle="#00e6ff";
 ctx.beginPath();
 ctx.moveTo(0,-40);
 ctx.lineTo(30,32);
 ctx.lineTo(0,22);
 ctx.lineTo(-30,32);
 ctx.closePath();
 ctx.fill();
 ctx.restore();

 if(stage==="boss" && ally) ctx.drawImage(imgAlly,ally.x-35,ally.y-35,70,70);

 enemies.forEach(e=>{ if(e.alive) ctx.drawImage(imgEnemy,e.x-45,e.y-45,90,90) });

 // ضرب اللاعب
 if(stage!=="lose") lasers.forEach(l=>{
  ctx.strokeStyle="#00ffff";ctx.lineWidth=6;
  ctx.beginPath();ctx.moveTo(l.x,l.y);
  ctx.lineTo(l.x,l.y-60);ctx.stroke();
 });

 // ضرب الحليف متعرج
 if(stage!=="lose") allyLasers.forEach(l=>{
  ctx.strokeStyle="#ff00ff";ctx.lineWidth=4;
  ctx.beginPath();ctx.moveTo(l.x,l.y);
  ctx.lineTo(l.x,l.y-40);ctx.stroke();
 });

 // ضرب البوص للاعب (مثل اللاعب) فقط إذا لم تخسر
 if(stage!=="lose") bossLasers.forEach(l=>{
  ctx.strokeStyle="#ffa500";ctx.lineWidth=6;
  ctx.beginPath();ctx.moveTo(l.x,l.y);
  ctx.lineTo(l.x,l.y+40);ctx.stroke();
 });

 if(stage==="boss") ctx.drawImage(imgBoss,boss.x-90,boss.y-90,180,180);

 // شاشة الفوز
 if(stage==="win"){
  winFly.forEach(f=>{
   f.x+=f.vx; f.y+=f.vy;
   if(f.x<0||f.x>canvas.width) f.vx*=-1;
   if(f.y<0||f.y>canvas.height) f.vy*=-1;
   ctx.drawImage(imgWin,f.x-f.size/2,f.y-f.size/2,f.size,f.size);
  });
  ctx.drawImage(imgWin,canvas.width/2-300,canvas.height/2-300,600,600);
 }

 // شاشة الخسارة
 if(stage==="lose"){
  ctx.fillStyle="red"; ctx.font="bold 48px Arial";
  ctx.textAlign="center";
  ctx.fillText("لقد خسرت",canvas.width/2,canvas.height/2+50);
 }
}

function loop(){update();draw();requestAnimationFrame(loop)}
loop();
</script>
</body>
</html>
